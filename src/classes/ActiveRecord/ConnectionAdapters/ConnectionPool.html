---
title: ActiveRecord::ConnectionAdapters::ConnectionPool
layout: default
---
<div class="main">
    <div class="banner">
        
            <span>Ruby on Rails 7.2.0.beta2</span><br />
        
        <div class="type">Class</div>
        <h1>
            ActiveRecord::ConnectionAdapters::ConnectionPool
            
                <span class="parent">&lt;
                    
                    <a href="../../Object.html">Object</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/activerecord/lib/active_record/connection_adapters/abstract/connection_pool_rb.html">activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb</a></li>
            
            <li><a href="../../../files/activerecord/lib/active_record/connection_adapters/abstract/connection_pool/queue_rb.html">activerecord/lib/active_record/connection_adapters/abstract/connection_pool/queue.rb</a></li>
            
            <li><a href="../../../files/activerecord/lib/active_record/connection_adapters/abstract/connection_pool/reaper_rb.html">activerecord/lib/active_record/connection_adapters/abstract/connection_pool/reaper.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<h1 id="class-ActiveRecord::ConnectionAdapters::ConnectionPool-label-Active+Record+Connection+Pool">Active Record Connection Pool</h1>

<p>Connection pool base class for managing Active Record database connections.</p>

<h2 id="class-ActiveRecord::ConnectionAdapters::ConnectionPool-label-Introduction">Introduction</h2>

<p>A connection pool synchronizes thread access to a limited number of database connections. The basic idea is that each thread checks out a database connection from the pool, uses that connection, and checks the connection back in. <a href="ConnectionPool.html"><code>ConnectionPool</code></a> is completely thread-safe, and will ensure that a connection cannot be used by two threads at the same time, as long as ConnectionPool’s contract is correctly followed. It will also handle cases in which there are more threads than connections: if all connections have been checked out, and a thread tries to checkout a connection anyway, then <a href="ConnectionPool.html"><code>ConnectionPool</code></a> will wait until some other thread has checked in a connection, or the <code>checkout_timeout</code> has expired.</p>

<h2 id="class-ActiveRecord::ConnectionAdapters::ConnectionPool-label-Obtaining+-28checking+out-29+a+connection">Obtaining (checking out) a connection</h2>

<p>Connections can be obtained and used from a connection pool in several ways:</p>
<ol><li>
<p>Simply use <a href="../ConnectionHandling.html#method-i-lease_connection">ActiveRecord::Base.lease_connection</a>. When you’re done with the connection(s) and wish it to be returned to the pool, you call <a href="ConnectionHandler.html#method-i-clear_active_connections-21">ActiveRecord::Base.connection_handler.clear_active_connections!</a>. This is the default behavior for Active Record when used in conjunction with Action Pack’s request handling cycle.</p>
</li><li>
<p>Manually check out a connection from the pool with <a href="ConnectionPool.html#method-i-checkout">ActiveRecord::Base.connection_pool.checkout</a>. You are responsible for returning this connection to the pool when finished by calling <a href="ConnectionPool.html#method-i-checkin">ActiveRecord::Base.connection_pool.checkin(connection)</a>.</p>
</li><li>
<p>Use <a href="ConnectionPool.html#method-i-with_connection">ActiveRecord::Base.connection_pool.with_connection(&amp;block)</a>, which obtains a connection, yields it as the sole argument to the block, and returns it to the pool after the block completes.</p>
</li></ol>

<p>Connections in the pool are actually <a href="AbstractAdapter.html"><code>AbstractAdapter</code></a> objects (or objects compatible with AbstractAdapter’s interface).</p>

<p>While a thread has a connection checked out from the pool using one of the above three methods, that connection will automatically be the one used by <a href="../../ActiveRecord.html"><code>ActiveRecord</code></a> queries executing on that thread. It is not required to explicitly pass the checked out connection to Rails models or queries, for example.</p>

<h2 id="class-ActiveRecord::ConnectionAdapters::ConnectionPool-label-Options">Options</h2>

<p>There are several connection-pooling-related options that you can add to your database connection configuration:</p>
<ul><li>
<p><code>pool</code>: maximum number of connections the pool may manage (default 5).</p>
</li><li>
<p><code>idle_timeout</code>: number of seconds that a connection will be kept unused in the pool before it is automatically disconnected (default 300 seconds). Set this to zero to keep connections forever.</p>
</li><li>
<p><code>checkout_timeout</code>: number of seconds to wait for a connection to become available before giving up and raising a timeout error (default 5 seconds).</p>
</li></ul>

    </div>
  

  

  
  


  
    <h2 id="namespace">Namespace</h2>

    

    
      <h3 id="class">Class</h3>
      <ul>
      
        <li><a href="ConnectionPool/Queue.html">ActiveRecord::ConnectionAdapters::ConnectionPool::Queue</a></li>
      
        <li><a href="ConnectionPool/Reaper.html">ActiveRecord::ConnectionAdapters::ConnectionPool::Reaper</a></li>
      
      </ul>
    
  

  
    <h2 id="methods">Methods</h2>
    <ul>
      
        <li>
          <a href="#method-i-active_connection-3F">active_connection?</a>
        </li>
      
        <li>
          <a href="#method-i-checkin">checkin</a>
        </li>
      
        <li>
          <a href="#method-i-checkout">checkout</a>
        </li>
      
        <li>
          <a href="#method-i-clear_reloadable_connections">clear_reloadable_connections</a>
        </li>
      
        <li>
          <a href="#method-i-clear_reloadable_connections-21">clear_reloadable_connections!</a>
        </li>
      
        <li>
          <a href="#method-i-connected-3F">connected?</a>
        </li>
      
        <li>
          <a href="#method-i-connection">connection</a>
        </li>
      
        <li>
          <a href="#method-i-connections">connections</a>
        </li>
      
        <li>
          <a href="#method-i-disconnect">disconnect</a>
        </li>
      
        <li>
          <a href="#method-i-disconnect-21">disconnect!</a>
        </li>
      
        <li>
          <a href="#method-i-flush">flush</a>
        </li>
      
        <li>
          <a href="#method-i-flush-21">flush!</a>
        </li>
      
        <li>
          <a href="#method-i-lease_connection">lease_connection</a>
        </li>
      
        <li>
          <a href="#method-c-new">new</a>
        </li>
      
        <li>
          <a href="#method-i-reap">reap</a>
        </li>
      
        <li>
          <a href="#method-i-release_connection">release_connection</a>
        </li>
      
        <li>
          <a href="#method-i-remove">remove</a>
        </li>
      
        <li>
          <a href="#method-i-schema_cache">schema_cache</a>
        </li>
      
        <li>
          <a href="#method-i-schema_reflection-3D">schema_reflection=</a>
        </li>
      
        <li>
          <a href="#method-i-stat">stat</a>
        </li>
      
        <li>
          <a href="#method-i-with_connection">with_connection</a>
        </li>
      
    </ul>
  

  
    <!-- Includes -->
    <h2 id="included-modules">Included Modules</h2>
    <ul>
      
        <li>
          
            MonitorMixin
          
        </li>
      
    </ul>
  

  
    

    

    

    
      <!-- Section attributes -->
      <h2 id="attributes">Attributes</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>async_executor</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>automatic_reconnect</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>checkout_timeout</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>db_config</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>pool_config</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>reaper</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>role</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>shard</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>size</td>
            <td class='attr-desc'></td>
          </tr>
        
      </table>
    

    <!-- Methods -->
    
      <h2 id="class-public-methods">Class Public methods</h2>
      
        <div class="method">
          <h3 id="method-c-new">
            
              new(pool_config)
            
          </h3>

          
            <div class="description">
              <p>Creates a new <a href="ConnectionPool.html"><code>ConnectionPool</code></a> object. <code>pool_config</code> is a PoolConfig object which describes database connection information (e.g. adapter, host name, username, password, etc), as well as the maximum size for this <a href="ConnectionPool.html"><code>ConnectionPool</code></a>.</p>

<p>The default <a href="ConnectionPool.html"><code>ConnectionPool</code></a> maximum size is 5.</p>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 220
      def initialize(pool_config)
        super()

        @pool_config = pool_config
        @db_config = pool_config.db_config
        @role = pool_config.role
        @shard = pool_config.shard

        @checkout_timeout = db_config.checkout_timeout
        @idle_timeout = db_config.idle_timeout
        @size = db_config.pool

        # This variable tracks the cache of threads mapped to reserved connections, with the
        # sole purpose of speeding up the +connection+ method. It is not the authoritative
        # registry of which thread owns which connection. Connection ownership is tracked by
        # the +connection.owner+ attr on each +connection+ instance.
        # The invariant works like this: if there is mapping of &lt;tt&gt;thread =&gt; conn&lt;/tt&gt;,
        # then that +thread+ does indeed own that +conn+. However, an absence of such
        # mapping does not mean that the +thread+ doesn&#39;t own the said connection. In
        # that case +conn.owner+ attr should be consulted.
        # Access and modification of &lt;tt&gt;@leases&lt;/tt&gt; does not require
        # synchronization.
        @leases = LeaseRegistry.new

        @connections         = []
        @automatic_reconnect = true

        # Connection pool allows for concurrent (outside the main +synchronize+ section)
        # establishment of new connections. This variable tracks the number of threads
        # currently in the process of independently establishing connections to the DB.
        @now_connecting = 0

        @threads_blocking_new_connections = 0

        @available = ConnectionLeasingQueue.new self
        @pinned_connection = nil

        @async_executor = build_async_executor

        @schema_cache = nil

        @reaper = Reaper.new(self, db_config.reaping_frequency)
        @reaper.run
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L220" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
      
    
      <h2 id="instance-public-methods">Instance Public methods</h2>
      
        <div class="method">
          <h3 id="method-i-active_connection-3F">
            
              active_connection?()
            
          </h3>

          
            <div class="description">
              <p>Returns true if there is an open connection being used for the current thread.</p>

<p>This method only works for connections that have been obtained through <a href="ConnectionPool.html#method-i-lease_connection"><code>lease_connection</code></a> or <a href="ConnectionPool.html#method-i-with_connection"><code>with_connection</code></a> methods. Connections obtained through <a href="ConnectionPool.html#method-i-checkout"><code>checkout</code></a> will not be detected by <a href="ConnectionPool.html#method-i-active_connection-3F"><code>active_connection?</code></a></p>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 357
      def active_connection?
        connection_lease.connection
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L357" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-checkin">
            
              checkin(conn)
            
          </h3>

          
            <div class="description">
              <p>Check-in a database connection back into the pool, indicating that you no longer need this connection.</p>

<p><code>conn</code>: an <a href="AbstractAdapter.html"><code>AbstractAdapter</code></a> object, which was obtained by earlier by calling <a href="ConnectionPool.html#method-i-checkout"><code>checkout</code></a> on this pool.</p>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 549
      def checkin(conn)
        return if @pinned_connection.equal?(conn)

        conn.lock.synchronize do
          synchronize do
            connection_lease.clear(conn)

            conn._run_checkin_callbacks do
              conn.expire
            end

            @available.add conn
          end
        end
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L549" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-checkout">
            
              checkout(checkout_timeout = @checkout_timeout)
            
          </h3>

          
            <div class="description">
              <p>Check-out a database connection from the pool, indicating that you want to use it. You should call <a href="ConnectionPool.html#method-i-checkin"><code>checkin</code></a> when you no longer need this.</p>

<p>This is done by either returning and leasing existing connection, or by creating a new connection and leasing it.</p>

<p>If all connections are leased and the pool is at capacity (meaning the number of currently leased connections is greater than or equal to the size limit set), an <a href="../ConnectionTimeoutError.html"><code>ActiveRecord::ConnectionTimeoutError</code></a> exception will be raised.</p>

<p>Returns: an <a href="AbstractAdapter.html"><code>AbstractAdapter</code></a> object.</p>

<p>Raises:</p>
<ul><li>
<p><a href="../ConnectionTimeoutError.html"><code>ActiveRecord::ConnectionTimeoutError</code></a> no connection can be obtained from the pool.</p>
</li></ul>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 528
      def checkout(checkout_timeout = @checkout_timeout)
        if @pinned_connection
          synchronize do
            @pinned_connection.verify!
            # Any leased connection must be in @connections otherwise
            # some methods like #connected? won&#39;t behave correctly
            unless @connections.include?(@pinned_connection)
              @connections &lt;&lt; @pinned_connection
            end
          end
          @pinned_connection
        else
          checkout_and_verify(acquire_connection(checkout_timeout))
        end
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L528" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-clear_reloadable_connections">
            
              clear_reloadable_connections(raise_on_acquisition_timeout = true)
            
          </h3>

          
            <div class="description">
              <p>Clears the cache which maps classes and re-connects connections that require reloading.</p>

<p>Raises:</p>
<ul><li>
<p><a href="../ExclusiveConnectionTimeoutError.html"><code>ActiveRecord::ExclusiveConnectionTimeoutError</code></a> if unable to gain ownership of all connections in the pool within a timeout interval (default duration is <code>spec.db_config.checkout_timeout * 2</code> seconds).</p>
</li></ul>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 486
      def clear_reloadable_connections(raise_on_acquisition_timeout = true)
        with_exclusively_acquired_all_connections(raise_on_acquisition_timeout) do
          synchronize do
            @connections.each do |conn|
              if conn.in_use?
                conn.steal!
                checkin conn
              end
              conn.disconnect! if conn.requires_reloading?
            end
            @connections.delete_if(&amp;:requires_reloading?)
            @available.clear
          end
        end
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L486" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-clear_reloadable_connections-21">
            
              clear_reloadable_connections!()
            
          </h3>

          
            <div class="description">
              <p>Clears the cache which maps classes and re-connects connections that require reloading.</p>

<p>The pool first tries to gain ownership of all connections. If unable to do so within a timeout interval (default duration is <code>spec.db_config.checkout_timeout * 2</code> seconds), then the pool forcefully clears the cache and reloads connections without any regard for other connection owning threads.</p>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 510
      def clear_reloadable_connections!
        clear_reloadable_connections(false)
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L510" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-connected-3F">
            
              connected?()
            
          </h3>

          
            <div class="description">
              <p>Returns true if a connection has already been opened.</p>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 408
      def connected?
        synchronize { @connections.any?(&amp;:connected?) }
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L408" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-connection">
            
              connection()
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 305
      def connection
        ActiveRecord.deprecator.warn(&lt;&lt;~MSG)
          ActiveRecord::ConnectionAdapters::ConnectionPool#connection is deprecated
          and will be removed in Rails 8.0. Use #lease_connection instead.
        MSG
        lease_connection
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L305" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-connections">
            
              connections()
            
          </h3>

          
            <div class="description">
              <p>Returns an array containing the connections currently in the pool. Access to the array does not require synchronization on the pool because the array is newly created and not retained by the pool.</p>

<p>However; this method bypasses the ConnectionPool’s thread-safe connection access pattern. A returned connection may be owned by another thread, unowned, or by happen-stance owned by the calling thread.</p>

<p>Calling methods on a connection without ownership is subject to the thread-safety guarantees of the underlying method. Many of the methods on connection adapter classes are inherently multi-thread unsafe.</p>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 423
      def connections
        synchronize { @connections.dup }
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L423" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-disconnect">
            
              disconnect(raise_on_acquisition_timeout = true)
            
          </h3>

          
            <div class="description">
              <p>Disconnects all connections in the pool, and clears the pool.</p>

<p>Raises:</p>
<ul><li>
<p><a href="../ExclusiveConnectionTimeoutError.html"><code>ActiveRecord::ExclusiveConnectionTimeoutError</code></a> if unable to gain ownership of all connections in the pool within a timeout interval (default duration is <code>spec.db_config.checkout_timeout * 2</code> seconds).</p>
</li></ul>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 433
      def disconnect(raise_on_acquisition_timeout = true)
        with_exclusively_acquired_all_connections(raise_on_acquisition_timeout) do
          synchronize do
            @connections.each do |conn|
              if conn.in_use?
                conn.steal!
                checkin conn
              end
              conn.disconnect!
            end
            @connections = []
            @leases.clear
            @available.clear
          end
        end
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L433" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-disconnect-21">
            
              disconnect!()
            
          </h3>

          
            <div class="description">
              <p>Disconnects all connections in the pool, and clears the pool.</p>

<p>The pool first tries to gain ownership of all connections. If unable to do so within a timeout interval (default duration is <code>spec.db_config.checkout_timeout * 2</code> seconds), then the pool is forcefully disconnected without any regard for other connection owning threads.</p>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 456
      def disconnect!
        disconnect(false)
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L456" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-flush">
            
              flush(minimum_idle = @idle_timeout)
            
          </h3>

          
            <div class="description">
              <p>Disconnect all connections that have been idle for at least <code>minimum_idle</code> seconds. Connections currently checked out, or that were checked in less than <code>minimum_idle</code> seconds ago, are unaffected.</p>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 624
      def flush(minimum_idle = @idle_timeout)
        return if minimum_idle.nil?

        idle_connections = synchronize do
          return if self.discarded?
          @connections.select do |conn|
            !conn.in_use? &amp;&amp; conn.seconds_idle &gt;= minimum_idle
          end.each do |conn|
            conn.lease

            @available.delete conn
            @connections.delete conn
          end
        end

        idle_connections.each do |conn|
          conn.disconnect!
        end
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L624" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-flush-21">
            
              flush!()
            
          </h3>

          
            <div class="description">
              <p>Disconnect all currently idle connections. Connections currently checked out are unaffected.</p>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 646
      def flush!
        reap
        flush(-1)
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L646" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-lease_connection">
            
              lease_connection()
            
          </h3>

          
            <div class="description">
              <p>Retrieve the connection associated with the current thread, or call <a href="ConnectionPool.html#method-i-checkout"><code>checkout</code></a> to obtain one if necessary.</p>

<p><a href="ConnectionPool.html#method-i-lease_connection"><code>lease_connection</code></a> can be called any number of times; the connection is held in a cache keyed by a thread.</p>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 295
      def lease_connection
        lease = connection_lease
        lease.sticky = true
        lease.connection ||= checkout
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L295" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-reap">
            
              reap()
            
          </h3>

          
            <div class="description">
              <p>Recover lost connections for the pool. A lost connection can occur if a programmer forgets to checkin a connection at the end of a thread or a thread dies unexpectedly.</p>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 599
      def reap
        stale_connections = synchronize do
          return if self.discarded?
          @connections.select do |conn|
            conn.in_use? &amp;&amp; !conn.owner.alive?
          end.each do |conn|
            conn.steal!
          end
        end

        stale_connections.each do |conn|
          if conn.active?
            conn.reset!
            checkin conn
          else
            remove conn
          end
        end

        prune_thread_cache
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L599" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-release_connection">
            
              release_connection(existing_lease = nil)
            
          </h3>

          
            <div class="description">
              <p>Signal that the thread is finished with the current connection. <a href="ConnectionPool.html#method-i-release_connection"><code>release_connection</code></a> releases the connection-thread association and returns the connection to the pool.</p>

<p>This method only works for connections that have been obtained through <a href="ConnectionPool.html#method-i-lease_connection"><code>lease_connection</code></a> or <a href="ConnectionPool.html#method-i-with_connection"><code>with_connection</code></a> methods, connections obtained through <a href="ConnectionPool.html#method-i-checkout"><code>checkout</code></a> will not be automatically released.</p>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 369
      def release_connection(existing_lease = nil)
        if conn = connection_lease.release
          checkin conn
          return true
        end
        false
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L369" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-remove">
            
              remove(conn)
            
          </h3>

          
            <div class="description">
              <p>Remove a connection from the connection pool. The connection will remain open and active but will no longer be managed by this pool.</p>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 567
      def remove(conn)
        needs_new_connection = false

        synchronize do
          remove_connection_from_thread_cache conn

          @connections.delete conn
          @available.delete conn

          # @available.any_waiting? =&gt; true means that prior to removing this
          # conn, the pool was at its max size (@connections.size == @size).
          # This would mean that any threads stuck waiting in the queue wouldn&#39;t
          # know they could checkout_new_connection, so let&#39;s do it for them.
          # Because condition-wait loop is encapsulated in the Queue class
          # (that in turn is oblivious to ConnectionPool implementation), threads
          # that are &quot;stuck&quot; there are helpless. They have no way of creating
          # new connections and are completely reliant on us feeding available
          # connections into the Queue.
          needs_new_connection = @available.any_waiting?
        end

        # This is intentionally done outside of the synchronized section as we
        # would like not to hold the main mutex while checking out new connections.
        # Thus there is some chance that needs_new_connection information is now
        # stale, we can live with that (bulk_make_new_connections will make
        # sure not to exceed the pool&#39;s @size limit).
        bulk_make_new_connections(1) if needs_new_connection
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L567" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-schema_cache">
            
              schema_cache()
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 265
      def schema_cache
        @schema_cache ||= BoundSchemaReflection.new(schema_reflection, self)
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L265" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-schema_reflection-3D">
            
              schema_reflection=(schema_reflection)
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 269
      def schema_reflection=(schema_reflection)
        pool_config.schema_reflection = schema_reflection
        @schema_cache = nil
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L269" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-stat">
            
              stat()
            
          </h3>

          
            <div class="description">
              <p>Returns the connection pool’s usage statistic.</p>

<pre><code>ActiveRecord::Base.connection_pool.stat # =&gt; { size: 15, connections: 1, busy: 1, dead: 0, idle: 0, waiting: 0, checkout_timeout: 5 }
</code></pre>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 658
      def stat
        synchronize do
          {
            size: size,
            connections: @connections.size,
            busy: @connections.count { |c| c.in_use? &amp;&amp; c.owner.alive? },
            dead: @connections.count { |c| c.in_use? &amp;&amp; !c.owner.alive? },
            idle: @connections.count { |c| !c.in_use? },
            waiting: num_waiting_in_queue,
            checkout_timeout: checkout_timeout
          }
        end
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L658" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
        <div class="method">
          <h3 id="method-i-with_connection">
            
              with_connection(prevent_permanent_checkout: false)
            
          </h3>

          
            <div class="description">
              <p>Yields a connection from the connection pool to the block. If no connection is already checked out by the current thread, a connection will be checked out from the pool, yielded to the block, and then returned to the pool when the block is finished. If a connection has already been checked out on the current thread, such as via <a href="ConnectionPool.html#method-i-lease_connection"><code>lease_connection</code></a> or <a href="ConnectionPool.html#method-i-with_connection"><code>with_connection</code></a>, that existing connection will be the one yielded and it will not be returned to the pool automatically at the end of the block; it is expected that such an existing connection will be properly returned to the pool by the code that checked it out.</p>
            </div>
          

          

          

          
          
            <details class="method__source">
              <summary>
                <span class="label">📝 Source code</span>
              </summary>

              <pre><code class="ruby"># File activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb, line 386
      def with_connection(prevent_permanent_checkout: false)
        lease = connection_lease
        sticky_was = lease.sticky
        lease.sticky = false if prevent_permanent_checkout

        if lease.connection
          begin
            yield lease.connection
          ensure
            lease.sticky = sticky_was if prevent_permanent_checkout &amp;&amp; !sticky_was
          end
        else
          begin
            yield lease.connection = checkout
          ensure
            lease.sticky = sticky_was if prevent_permanent_checkout &amp;&amp; !sticky_was
            release_connection(lease) unless lease.sticky
          end
        end
      end</code></pre>
              
                <a href="https://github.com/rails/rails/blob/b752c38e81a310c1aaca78c7cdd1784009ea189a/activerecord/lib/active_record/connection_adapters/abstract/connection_pool.rb#L386" target="_blank" class="github_url">🔎 See on GitHub</a>
              
            </details>
          
        </div>
        
      
    
  
</div>

    </div>
</div>
