---
title: ActionController::RequestForgeryProtection
layout: default
---
<div class="main">
    <div class="banner">
        
            <span>Ruby on Rails 7.0.0.alpha2</span><br />
        
        <div class="type">Module</div>
        <h1>
            ActionController::RequestForgeryProtection
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/actionpack/lib/action_controller/metal/request_forgery_protection_rb.html">actionpack/lib/action_controller/metal/request_forgery_protection.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>Controller actions are protected from Cross-Site Request Forgery (CSRF) attacks by including a token in the rendered HTML for your application. This token is stored as a random string in the session, to which an attacker does not have access. When a request reaches your application, Rails verifies the received token with the token in the session. All requests are checked except GET requests as these should be idempotent. Keep in mind that all session-oriented requests are CSRF protected by default, including JavaScript and HTML requests.</p>

<p>Since HTML and JavaScript requests are typically made from the browser, we need to ensure to verify request authenticity for the web browser. We can use session-oriented authentication for these types of requests, by using the <code>protect_from_forgery</code> method in our controllers.</p>

<p>GET requests are not protected since they don&#39;t have side effects like writing to the database and don&#39;t leak sensitive information. JavaScript requests are an exception: a third-party site can use a &lt;script&gt; tag to reference a JavaScript URL on your site. When your JavaScript response loads on their site, it executes. With carefully crafted JavaScript on their end, sensitive data in your JavaScript response may be extracted. To prevent this, only XmlHttpRequest (known as XHR or Ajax) requests are allowed to make requests for JavaScript responses.</p>

<p>Subclasses of <code>ActionController::Base</code> are protected by default with the <code>:exception</code> strategy, which raises an <code>ActionController::InvalidAuthenticityToken</code> error on unverified requests.</p>

<p>APIs may want to disable this behavior since they are typically designed to be state-less: that is, the request <a href="API.html"><code>API</code></a> client handles the session instead of Rails. One way to achieve this is to use the <code>:null_session</code> strategy instead, which allows unverified requests to be handled, but with an empty session:</p>

<pre><code>class ApplicationController &lt; ActionController::Base
  protect_from_forgery with: :null_session
end
</code></pre>

<p>Note that <a href="API.html"><code>API</code></a> only applications don&#39;t include this module or a session middleware by default, and so don&#39;t require CSRF protection to be configured.</p>

<p>The token parameter is named <code>authenticity_token</code> by default. The name and value of this token must be added to every layout that renders forms by including <code>csrf_meta_tags</code> in the HTML <code>head</code>.</p>

<p>Learn more about CSRF attacks and securing your application in the <a href="https://guides.rubyonrails.org/security.html">Ruby on Rails Security Guide</a>.</p>

    </div>
  

  

  
  


  
    <h2 id="namespace">Namespace</h2>

    
      <h3 id="module">Module</h3>
      <ul>
      
        <li><a href="RequestForgeryProtection/ClassMethods.html">ActionController::RequestForgeryProtection::ClassMethods</a></li>
      
        <li><a href="RequestForgeryProtection/ProtectionMethods.html">ActionController::RequestForgeryProtection::ProtectionMethods</a></li>
      
      </ul>
    

    
      <h3 id="class">Class</h3>
      <ul>
      
        <li><a href="RequestForgeryProtection/DisabledSessionError.html">ActionController::RequestForgeryProtection::DisabledSessionError</a></li>
      
      </ul>
    
  

  
    <h2 id="methods">Methods</h2>
    <ul>
      
        <li>
          <a href="#method-i-any_authenticity_token_valid-3F">any_authenticity_token_valid?</a>
        </li>
      
        <li>
          <a href="#method-i-compare_with_global_token">compare_with_global_token</a>
        </li>
      
        <li>
          <a href="#method-i-compare_with_real_token">compare_with_real_token</a>
        </li>
      
        <li>
          <a href="#method-i-csrf_token_hmac">csrf_token_hmac</a>
        </li>
      
        <li>
          <a href="#method-i-form_authenticity_param">form_authenticity_param</a>
        </li>
      
        <li>
          <a href="#method-i-form_authenticity_token">form_authenticity_token</a>
        </li>
      
        <li>
          <a href="#method-i-global_csrf_token">global_csrf_token</a>
        </li>
      
        <li>
          <a href="#method-i-handle_unverified_request">handle_unverified_request</a>
        </li>
      
        <li>
          <a href="#method-i-mark_for_same_origin_verification-21">mark_for_same_origin_verification!</a>
        </li>
      
        <li>
          <a href="#method-i-marked_for_same_origin_verification-3F">marked_for_same_origin_verification?</a>
        </li>
      
        <li>
          <a href="#method-i-mask_token">mask_token</a>
        </li>
      
        <li>
          <a href="#method-i-non_xhr_javascript_response-3F">non_xhr_javascript_response?</a>
        </li>
      
        <li>
          <a href="#method-i-normalize_action_path">normalize_action_path</a>
        </li>
      
        <li>
          <a href="#method-i-per_form_csrf_token">per_form_csrf_token</a>
        </li>
      
        <li>
          <a href="#method-i-protect_against_forgery-3F">protect_against_forgery?</a>
        </li>
      
        <li>
          <a href="#method-i-real_csrf_token">real_csrf_token</a>
        </li>
      
        <li>
          <a href="#method-i-request_authenticity_tokens">request_authenticity_tokens</a>
        </li>
      
        <li>
          <a href="#method-i-unmask_token">unmask_token</a>
        </li>
      
        <li>
          <a href="#method-i-valid_authenticity_token-3F">valid_authenticity_token?</a>
        </li>
      
        <li>
          <a href="#method-i-valid_per_form_csrf_token-3F">valid_per_form_csrf_token?</a>
        </li>
      
        <li>
          <a href="#method-i-valid_request_origin-3F">valid_request_origin?</a>
        </li>
      
        <li>
          <a href="#method-i-verified_request-3F">verified_request?</a>
        </li>
      
        <li>
          <a href="#method-i-verify_authenticity_token">verify_authenticity_token</a>
        </li>
      
        <li>
          <a href="#method-i-verify_same_origin_request">verify_same_origin_request</a>
        </li>
      
        <li>
          <a href="#method-i-xor_byte_strings">xor_byte_strings</a>
        </li>
      
    </ul>
  

  
    <!-- Includes -->
    <h2 id="included-modules">Included Modules</h2>
    <ul>
      
        <li>
          
            <a href="../AbstractController/Helpers.html">
              AbstractController::Helpers
            </a>
          
        </li>
      
        <li>
          
            <a href="../AbstractController/Callbacks.html">
              AbstractController::Callbacks
            </a>
          
        </li>
      
    </ul>
  

  
    

    

    
      <!-- Section constants -->
      <h2 id="constants">Constants</h2>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">AUTHENTICITY_TOKEN_LENGTH</td>
            <td>=</td>
            <td class="attr-value">32</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">NULL_ORIGIN_MESSAGE</td>
            <td>=</td>
            <td class="attr-value">&lt;&lt;~MSG</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"></td>
            </tr>
          
        
      </table>
    

    

    <!-- Methods -->
    
    
      <h2 id="instance-private-methods">Instance Private methods</h2>
      
        <div class="method">
          <h3 id="method-i-any_authenticity_token_valid-3F">
            
              any_authenticity_token_valid?()
            
          </h3>

          
            <div class="description">
              <p>Checks if any of the authenticity tokens from the request are valid.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-any_authenticity_token_valid-3F_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 326</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">any_authenticity_token_valid?</span> <span class="ruby-comment"># :doc:</span>
  <span class="ruby-identifier">request_authenticity_tokens</span>.<span class="ruby-identifier">any?</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">token</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">valid_authenticity_token?</span>(<span class="ruby-identifier">session</span>, <span class="ruby-identifier">token</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-compare_with_global_token">
            
              compare_with_global_token(token, session)
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-compare_with_global_token_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 412</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">compare_with_global_token</span>(<span class="ruby-identifier">token</span>, <span class="ruby-identifier">session</span>) <span class="ruby-comment"># :doc:</span>
  <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">SecurityUtils</span>.<span class="ruby-identifier">fixed_length_secure_compare</span>(<span class="ruby-identifier">token</span>, <span class="ruby-identifier">global_csrf_token</span>(<span class="ruby-identifier">session</span>))
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-compare_with_real_token">
            
              compare_with_real_token(token, session)
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-compare_with_real_token_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 408</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">compare_with_real_token</span>(<span class="ruby-identifier">token</span>, <span class="ruby-identifier">session</span>) <span class="ruby-comment"># :doc:</span>
  <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">SecurityUtils</span>.<span class="ruby-identifier">fixed_length_secure_compare</span>(<span class="ruby-identifier">token</span>, <span class="ruby-identifier">real_csrf_token</span>(<span class="ruby-identifier">session</span>))
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-csrf_token_hmac">
            
              csrf_token_hmac(session, identifier)
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-csrf_token_hmac_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 446</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">csrf_token_hmac</span>(<span class="ruby-identifier">session</span>, <span class="ruby-identifier">identifier</span>) <span class="ruby-comment"># :doc:</span>
  <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">HMAC</span>.<span class="ruby-identifier">digest</span>(
    <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Digest</span><span class="ruby-operator">::</span><span class="ruby-constant">SHA256</span>.<span class="ruby-identifier">new</span>,
    <span class="ruby-identifier">real_csrf_token</span>(<span class="ruby-identifier">session</span>),
    <span class="ruby-identifier">identifier</span>
  )
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-form_authenticity_param">
            
              form_authenticity_param()
            
          </h3>

          
            <div class="description">
              <p>The form&#39;s authenticity parameter. Override to provide your own.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-form_authenticity_param_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 466</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">form_authenticity_param</span> <span class="ruby-comment"># :doc:</span>
  <span class="ruby-identifier">params</span>[<span class="ruby-identifier">request_forgery_protection_token</span>]
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-form_authenticity_token">
            
              form_authenticity_token(form_options: {})
            
          </h3>

          
            <div class="description">
              <p>Creates the authenticity token for the current request.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-form_authenticity_token_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 338</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">form_authenticity_token</span>(<span class="ruby-value">form_options:</span> {}) <span class="ruby-comment"># :doc:</span>
  <span class="ruby-identifier">masked_authenticity_token</span>(<span class="ruby-identifier">session</span>, <span class="ruby-value">form_options:</span> <span class="ruby-identifier">form_options</span>)
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-global_csrf_token">
            
              global_csrf_token(session)
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-global_csrf_token_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 442</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">global_csrf_token</span>(<span class="ruby-identifier">session</span>) <span class="ruby-comment"># :doc:</span>
  <span class="ruby-identifier">csrf_token_hmac</span>(<span class="ruby-identifier">session</span>, <span class="ruby-constant">GLOBAL_CSRF_TOKEN_IDENTIFIER</span>)
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-handle_unverified_request">
            
              handle_unverified_request()
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-handle_unverified_request_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 259</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">handle_unverified_request</span> <span class="ruby-comment"># :doc:</span>
  <span class="ruby-identifier">protection_strategy</span> = <span class="ruby-identifier">forgery_protection_strategy</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword">self</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">protection_strategy</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:warning_message</span>)
    <span class="ruby-identifier">protection_strategy</span>.<span class="ruby-identifier">warning_message</span> = <span class="ruby-identifier">unverified_request_warning_message</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">protection_strategy</span>.<span class="ruby-identifier">handle_unverified_request</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-mark_for_same_origin_verification-21">
            
              mark_for_same_origin_verification!()
            
          </h3>

          
            <div class="description">
              <p>GET requests are checked for cross-origin JavaScript after rendering.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-mark_for_same_origin_verification-21_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 298</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mark_for_same_origin_verification!</span> <span class="ruby-comment"># :doc:</span>
  <span class="ruby-ivar">@marked_for_same_origin_verification</span> = <span class="ruby-identifier">request</span>.<span class="ruby-identifier">get?</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-marked_for_same_origin_verification-3F">
            
              marked_for_same_origin_verification?()
            
          </h3>

          
            <div class="description">
              <p>If the <code>verify_authenticity_token</code> before_action ran, verify that JavaScript responses are only served to same-origin GET requests.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-marked_for_same_origin_verification-3F_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 304</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">marked_for_same_origin_verification?</span> <span class="ruby-comment"># :doc:</span>
  <span class="ruby-ivar">@marked_for_same_origin_verification</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-mask_token">
            
              mask_token(raw_token)
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-mask_token_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 401</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mask_token</span>(<span class="ruby-identifier">raw_token</span>) <span class="ruby-comment"># :doc:</span>
  <span class="ruby-identifier">one_time_pad</span> = <span class="ruby-constant">SecureRandom</span>.<span class="ruby-identifier">random_bytes</span>(<span class="ruby-constant">AUTHENTICITY_TOKEN_LENGTH</span>)
  <span class="ruby-identifier">encrypted_csrf_token</span> = <span class="ruby-identifier">xor_byte_strings</span>(<span class="ruby-identifier">one_time_pad</span>, <span class="ruby-identifier">raw_token</span>)
  <span class="ruby-identifier">masked_token</span> = <span class="ruby-identifier">one_time_pad</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">encrypted_csrf_token</span>
  <span class="ruby-identifier">encode_csrf_token</span>(<span class="ruby-identifier">masked_token</span>)
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-non_xhr_javascript_response-3F">
            
              non_xhr_javascript_response?()
            
          </h3>

          
            <div class="description">
              <p>Check for cross-origin JavaScript responses.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-non_xhr_javascript_response-3F_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 309</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">non_xhr_javascript_response?</span> <span class="ruby-comment"># :doc:</span>
  <span class="ruby-regexp">%r(\A(?:text|application)/javascript)</span>.<span class="ruby-identifier">match?</span>(<span class="ruby-identifier">media_type</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-normalize_action_path">
            
              normalize_action_path(action_path)
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-normalize_action_path_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 509</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">normalize_action_path</span>(<span class="ruby-identifier">action_path</span>) <span class="ruby-comment"># :doc:</span>
  <span class="ruby-identifier">uri</span> = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">action_path</span>)
  <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">path</span>.<span class="ruby-identifier">chomp</span>(<span class="ruby-string">&quot;/&quot;</span>)
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-per_form_csrf_token">
            
              per_form_csrf_token(session, action_path, method)
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-per_form_csrf_token_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 435</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">per_form_csrf_token</span>(<span class="ruby-identifier">session</span>, <span class="ruby-identifier">action_path</span>, <span class="ruby-identifier">method</span>) <span class="ruby-comment"># :doc:</span>
  <span class="ruby-identifier">csrf_token_hmac</span>(<span class="ruby-identifier">session</span>, [<span class="ruby-identifier">action_path</span>, <span class="ruby-identifier">method</span>.<span class="ruby-identifier">downcase</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;#&quot;</span>))
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-protect_against_forgery-3F">
            
              protect_against_forgery?()
            
          </h3>

          
            <div class="description">
              <p>Checks if the controller allows forgery protection.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-protect_against_forgery-3F_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 471</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">protect_against_forgery?</span> <span class="ruby-comment"># :doc:</span>
  <span class="ruby-identifier">allow_forgery_protection</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ensure_session_is_enabled!</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-real_csrf_token">
            
              real_csrf_token(session)
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-real_csrf_token_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 430</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">real_csrf_token</span>(<span class="ruby-identifier">session</span>) <span class="ruby-comment"># :doc:</span>
  <span class="ruby-identifier">session</span>[<span class="ruby-value">:_csrf_token</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">generate_csrf_token</span>
  <span class="ruby-identifier">decode_csrf_token</span>(<span class="ruby-identifier">session</span>[<span class="ruby-value">:_csrf_token</span>])
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-request_authenticity_tokens">
            
              request_authenticity_tokens()
            
          </h3>

          
            <div class="description">
              <p>Possible authenticity tokens sent in the request.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-request_authenticity_tokens_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 333</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">request_authenticity_tokens</span> <span class="ruby-comment"># :doc:</span>
  [<span class="ruby-identifier">form_authenticity_param</span>, <span class="ruby-identifier">request</span>.<span class="ruby-identifier">x_csrf_token</span>]
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-unmask_token">
            
              unmask_token(masked_token)
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-unmask_token_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 393</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">unmask_token</span>(<span class="ruby-identifier">masked_token</span>) <span class="ruby-comment"># :doc:</span>
  <span class="ruby-comment"># Split the token into the one-time pad and the encrypted</span>
  <span class="ruby-comment"># value and decrypt it.</span>
  <span class="ruby-identifier">one_time_pad</span> = <span class="ruby-identifier">masked_token</span>[<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-constant">AUTHENTICITY_TOKEN_LENGTH</span>]
  <span class="ruby-identifier">encrypted_csrf_token</span> = <span class="ruby-identifier">masked_token</span>[<span class="ruby-constant">AUTHENTICITY_TOKEN_LENGTH</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
  <span class="ruby-identifier">xor_byte_strings</span>(<span class="ruby-identifier">one_time_pad</span>, <span class="ruby-identifier">encrypted_csrf_token</span>)
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-valid_authenticity_token-3F">
            
              valid_authenticity_token?(session, encoded_masked_token)
            
          </h3>

          
            <div class="description">
              <p>Checks the client&#39;s masked token to see if it matches the session token. Essentially the inverse of <code>masked_authenticity_token</code>.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-valid_authenticity_token-3F_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 361</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">valid_authenticity_token?</span>(<span class="ruby-identifier">session</span>, <span class="ruby-identifier">encoded_masked_token</span>) <span class="ruby-comment"># :doc:</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">encoded_masked_token</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">encoded_masked_token</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">encoded_masked_token</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">masked_token</span> = <span class="ruby-identifier">decode_csrf_token</span>(<span class="ruby-identifier">encoded_masked_token</span>)
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-comment"># encoded_masked_token is invalid Base64</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># See if it&#39;s actually a masked token or not. In order to</span>
  <span class="ruby-comment"># deploy this code, we should be able to handle any unmasked</span>
  <span class="ruby-comment"># tokens that we&#39;ve issued without error.</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">masked_token</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-constant">AUTHENTICITY_TOKEN_LENGTH</span>
    <span class="ruby-comment"># This is actually an unmasked token. This is expected if</span>
    <span class="ruby-comment"># you have just upgraded to masked tokens, but should stop</span>
    <span class="ruby-comment"># happening shortly after installing this gem.</span>
    <span class="ruby-identifier">compare_with_real_token</span> <span class="ruby-identifier">masked_token</span>, <span class="ruby-identifier">session</span>

  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">masked_token</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-constant">AUTHENTICITY_TOKEN_LENGTH</span> <span class="ruby-operator">*</span> <span class="ruby-value">2</span>
    <span class="ruby-identifier">csrf_token</span> = <span class="ruby-identifier">unmask_token</span>(<span class="ruby-identifier">masked_token</span>)

    <span class="ruby-identifier">compare_with_global_token</span>(<span class="ruby-identifier">csrf_token</span>, <span class="ruby-identifier">session</span>) <span class="ruby-operator">||</span>
      <span class="ruby-identifier">compare_with_real_token</span>(<span class="ruby-identifier">csrf_token</span>, <span class="ruby-identifier">session</span>) <span class="ruby-operator">||</span>
      <span class="ruby-identifier">valid_per_form_csrf_token?</span>(<span class="ruby-identifier">csrf_token</span>, <span class="ruby-identifier">session</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">false</span> <span class="ruby-comment"># Token is malformed.</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-valid_per_form_csrf_token-3F">
            
              valid_per_form_csrf_token?(token, session)
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-valid_per_form_csrf_token-3F_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 416</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">valid_per_form_csrf_token?</span>(<span class="ruby-identifier">token</span>, <span class="ruby-identifier">session</span>) <span class="ruby-comment"># :doc:</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">per_form_csrf_tokens</span>
    <span class="ruby-identifier">correct_token</span> = <span class="ruby-identifier">per_form_csrf_token</span>(
      <span class="ruby-identifier">session</span>,
      <span class="ruby-identifier">request</span>.<span class="ruby-identifier">path</span>.<span class="ruby-identifier">chomp</span>(<span class="ruby-string">&quot;/&quot;</span>),
      <span class="ruby-identifier">request</span>.<span class="ruby-identifier">request_method</span>
    )

    <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">SecurityUtils</span>.<span class="ruby-identifier">fixed_length_secure_compare</span>(<span class="ruby-identifier">token</span>, <span class="ruby-identifier">correct_token</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-valid_request_origin-3F">
            
              valid_request_origin?()
            
          </h3>

          
            <div class="description">
              <p>Checks if the request originated from the same origin by looking at the Origin header.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-valid_request_origin-3F_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 499</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">valid_request_origin?</span> <span class="ruby-comment"># :doc:</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">forgery_protection_origin_check</span>
    <span class="ruby-comment"># We accept blank origin headers because some user agents don&#39;t send it.</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">InvalidAuthenticityToken</span>, <span class="ruby-constant">NULL_ORIGIN_MESSAGE</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">origin</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;null&quot;</span>
    <span class="ruby-identifier">request</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">origin</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">base_url</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-verified_request-3F">
            
              verified_request?()
            
          </h3>

          
            <div class="description">
              <p>Returns true or false if a request is verified. Checks:</p>
<ul><li>
<p>Is it a GET or HEAD request? GETs should be safe and idempotent</p>
</li><li>
<p>Does the <a href="RequestForgeryProtection.html#method-i-form_authenticity_token"><code>form_authenticity_token</code></a> match the given token value from the params?</p>
</li><li>
<p>Does the X-CSRF-Token header match the <a href="RequestForgeryProtection.html#method-i-form_authenticity_token"><code>form_authenticity_token</code></a>?</p>
</li></ul>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-verified_request-3F_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 320</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">verified_request?</span> <span class="ruby-comment"># :doc:</span>
  <span class="ruby-operator">!</span><span class="ruby-identifier">protect_against_forgery?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">get?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">head?</span> <span class="ruby-operator">||</span>
    (<span class="ruby-identifier">valid_request_origin?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">any_authenticity_token_valid?</span>)
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-verify_authenticity_token">
            
              verify_authenticity_token()
            
          </h3>

          
            <div class="description">
              <p>The actual before_action that is used to verify the CSRF token. Don&#39;t override this directly. Provide your own forgery protection strategy instead. If you override, you&#39;ll disable same-origin <code>&lt;script&gt;</code> verification.</p>

<p>Lean on the protect_from_forgery declaration to mark which actions are due for same-origin request verification. If protect_from_forgery is enabled on an action, this before_action flags its after_action to verify that JavaScript responses are for XHR requests, ensuring they follow the browser&#39;s same-origin policy.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-verify_authenticity_token_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 249</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">verify_authenticity_token</span> <span class="ruby-comment"># :doc:</span>
  <span class="ruby-identifier">mark_for_same_origin_verification!</span>

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">verified_request?</span>
    <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-identifier">unverified_request_warning_message</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">logger</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">log_warning_on_csrf_failure</span>

    <span class="ruby-identifier">handle_unverified_request</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-verify_same_origin_request">
            
              verify_same_origin_request()
            
          </h3>

          
            <div class="description">
              <p>If <code>verify_authenticity_token</code> was run (indicating that we have forgery protection enabled for this request) then also verify that we aren&#39;t serving an unauthorized cross-origin response.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-verify_same_origin_request_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 288</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">verify_same_origin_request</span> <span class="ruby-comment"># :doc:</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">marked_for_same_origin_verification?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">non_xhr_javascript_response?</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">logger</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">log_warning_on_csrf_failure</span>
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-constant">CROSS_ORIGIN_JAVASCRIPT_WARNING</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">InvalidCrossOriginRequest</span>, <span class="ruby-constant">CROSS_ORIGIN_JAVASCRIPT_WARNING</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-xor_byte_strings">
            
              xor_byte_strings(s1, s2)
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-xor_byte_strings_source">
                <pre><code class="ruby"><span class="ruby-comment"># File actionpack/lib/action_controller/metal/request_forgery_protection.rb, line 454</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">xor_byte_strings</span>(<span class="ruby-identifier">s1</span>, <span class="ruby-identifier">s2</span>) <span class="ruby-comment"># :doc:</span>
  <span class="ruby-identifier">s2</span> = <span class="ruby-identifier">s2</span>.<span class="ruby-identifier">dup</span>
  <span class="ruby-identifier">size</span> = <span class="ruby-identifier">s1</span>.<span class="ruby-identifier">bytesize</span>
  <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
  <span class="ruby-keyword">while</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">size</span>
    <span class="ruby-identifier">s2</span>.<span class="ruby-identifier">setbyte</span>(<span class="ruby-identifier">i</span>, <span class="ruby-identifier">s1</span>.<span class="ruby-identifier">getbyte</span>(<span class="ruby-identifier">i</span>) <span class="ruby-operator">^</span> <span class="ruby-identifier">s2</span>.<span class="ruby-identifier">getbyte</span>(<span class="ruby-identifier">i</span>))
    <span class="ruby-identifier">i</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">s2</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </div>
</div>
