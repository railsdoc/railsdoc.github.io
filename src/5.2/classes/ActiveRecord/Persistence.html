---
title: ActiveRecord::Persistence
layout: default
---
<div class="main">
    <div class="banner">
        
            <span>Ruby on Rails 5.2.8</span><br />
        
        <div class="type">Module</div>
        <h1>
            ActiveRecord::Persistence
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/activerecord/lib/active_record/persistence_rb.html">activerecord/lib/active_record/persistence.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<h1 id="module-ActiveRecord::Persistence-label-Active+Record+Persistence">Active Record Persistence</h1>

    </div>
  

  

  
  


  
    <h2 id="namespace">Namespace</h2>

    
      <h3 id="module">Module</h3>
      <ul>
      
        <li><a href="Persistence/ClassMethods.html">ActiveRecord::Persistence::ClassMethods</a></li>
      
      </ul>
    

    
  

  
    <h2 id="methods">Methods</h2>
    <ul>
      
        <li>
          <a href="#method-i-becomes">becomes</a>
        </li>
      
        <li>
          <a href="#method-i-becomes-21">becomes!</a>
        </li>
      
        <li>
          <a href="#method-i-decrement">decrement</a>
        </li>
      
        <li>
          <a href="#method-i-decrement-21">decrement!</a>
        </li>
      
        <li>
          <a href="#method-i-delete">delete</a>
        </li>
      
        <li>
          <a href="#method-i-destroy">destroy</a>
        </li>
      
        <li>
          <a href="#method-i-destroy-21">destroy!</a>
        </li>
      
        <li>
          <a href="#method-i-destroyed-3F">destroyed?</a>
        </li>
      
        <li>
          <a href="#method-i-increment">increment</a>
        </li>
      
        <li>
          <a href="#method-i-increment-21">increment!</a>
        </li>
      
        <li>
          <a href="#method-i-new_record-3F">new_record?</a>
        </li>
      
        <li>
          <a href="#method-i-persisted-3F">persisted?</a>
        </li>
      
        <li>
          <a href="#method-i-reload">reload</a>
        </li>
      
        <li>
          <a href="#method-i-save">save</a>
        </li>
      
        <li>
          <a href="#method-i-save-21">save!</a>
        </li>
      
        <li>
          <a href="#method-i-toggle">toggle</a>
        </li>
      
        <li>
          <a href="#method-i-toggle-21">toggle!</a>
        </li>
      
        <li>
          <a href="#method-i-touch">touch</a>
        </li>
      
        <li>
          <a href="#method-i-update">update</a>
        </li>
      
        <li>
          <a href="#method-i-update-21">update!</a>
        </li>
      
        <li>
          <a href="#method-i-update_attribute">update_attribute</a>
        </li>
      
        <li>
          <a href="#method-i-update_attributes">update_attributes</a>
        </li>
      
        <li>
          <a href="#method-i-update_attributes-21">update_attributes!</a>
        </li>
      
        <li>
          <a href="#method-i-update_column">update_column</a>
        </li>
      
        <li>
          <a href="#method-i-update_columns">update_columns</a>
        </li>
      
    </ul>
  

  

  
    

    

    

    

    <!-- Methods -->
    
    
      <h2 id="instance-public-methods">Instance Public methods</h2>
      
        <div class="method">
          <h3 id="method-i-becomes">
            
              becomes(klass)
            
          </h3>

          
            <div class="description">
              <p>Returns an instance of the specified <code>klass</code> with the attributes of the current record. This is mostly useful in relation to single-table inheritance structures where you want a subclass to appear as the superclass. This can be used along with record identification in Action Pack to allow, say, <code>Client &lt; Company</code> to do something like render <code>partial: @client.becomes(Company)</code> to render that instance using the companies/company partial instead of clients/client.</p>

<p>Note: The new instance will share a link to the same attributes as the original class. Therefore the sti column value will still be the same. Any change to the attributes on either instance will affect both instances. If you want to change the sti column as well, use <a href="Persistence.html#method-i-becomes-21"><code>becomes!</code></a> instead.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-becomes_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 372</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">becomes</span>(<span class="ruby-identifier">klass</span>)
  <span class="ruby-identifier">became</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">allocate</span>
  <span class="ruby-identifier">became</span>.<span class="ruby-identifier">send</span>(<span class="ruby-value">:initialize</span>)
  <span class="ruby-identifier">became</span>.<span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-string">&quot;@attributes&quot;</span>, <span class="ruby-ivar">@attributes</span>)
  <span class="ruby-identifier">became</span>.<span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-string">&quot;@mutations_from_database&quot;</span>, <span class="ruby-ivar">@mutations_from_database</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">became</span>.<span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-string">&quot;@changed_attributes&quot;</span>, <span class="ruby-identifier">attributes_changed_by_setter</span>)
  <span class="ruby-identifier">became</span>.<span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-string">&quot;@new_record&quot;</span>, <span class="ruby-identifier">new_record?</span>)
  <span class="ruby-identifier">became</span>.<span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-string">&quot;@destroyed&quot;</span>, <span class="ruby-identifier">destroyed?</span>)
  <span class="ruby-identifier">became</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">copy!</span>(<span class="ruby-identifier">errors</span>)
  <span class="ruby-identifier">became</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-becomes-21">
            
              becomes!(klass)
            
          </h3>

          
            <div class="description">
              <p>Wrapper around <a href="Persistence.html#method-i-becomes"><code>becomes</code></a> that also changes the instance&#39;s sti column value. This is especially useful if you want to persist the changed class in your database.</p>

<p>Note: The old instance&#39;s sti column value will be changed too, as both objects share the same set of attributes.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-becomes-21_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 390</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">becomes!</span>(<span class="ruby-identifier">klass</span>)
  <span class="ruby-identifier">became</span> = <span class="ruby-identifier">becomes</span>(<span class="ruby-identifier">klass</span>)
  <span class="ruby-identifier">sti_type</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">klass</span>.<span class="ruby-identifier">descends_from_active_record?</span>
    <span class="ruby-identifier">sti_type</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">sti_name</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">became</span>.<span class="ruby-identifier">public_send</span>(<span class="ruby-node">&quot;#{klass.inheritance_column}=&quot;</span>, <span class="ruby-identifier">sti_type</span>)
  <span class="ruby-identifier">became</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-decrement">
            
              decrement(attribute, by = 1)
            
          </h3>

          
            <div class="description">
              <p>Initializes <code>attribute</code> to zero if <code>nil</code> and subtracts the value passed as <code>by</code> (default is 1). The decrement is performed directly on the underlying attribute, no setter is invoked. Only makes sense for number-based attributes. Returns <code>self</code>.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-decrement_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 515</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">decrement</span>(<span class="ruby-identifier">attribute</span>, <span class="ruby-identifier">by</span> = <span class="ruby-value">1</span>)
  <span class="ruby-identifier">increment</span>(<span class="ruby-identifier">attribute</span>, <span class="ruby-operator">-</span><span class="ruby-identifier">by</span>)
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-decrement-21">
            
              decrement!(attribute, by = 1, touch: nil)
            
          </h3>

          
            <div class="description">
              <p>Wrapper around <a href="Persistence.html#method-i-decrement"><code>decrement</code></a> that writes the update to the database. Only <code>attribute</code> is updated; the record itself is not saved. This means that any other modified attributes will still be dirty. <a href="Validations.html"><code>Validations</code></a> and callbacks are skipped. Supports the <code>touch</code> option from <code>update_counters</code>, see that for more. Returns <code>self</code>.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-decrement-21_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 525</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">decrement!</span>(<span class="ruby-identifier">attribute</span>, <span class="ruby-identifier">by</span> = <span class="ruby-value">1</span>, <span class="ruby-value">touch:</span> <span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">increment!</span>(<span class="ruby-identifier">attribute</span>, <span class="ruby-operator">-</span><span class="ruby-identifier">by</span>, <span class="ruby-value">touch:</span> <span class="ruby-identifier">touch</span>)
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-delete">
            
              delete()
            
          </h3>

          
            <div class="description">
              <p>Deletes the record in the database and freezes this instance to reflect that no changes should be made (since they can&#39;t be persisted). Returns the frozen instance.</p>

<p>The row is simply removed with an SQL <code>DELETE</code> statement on the record&#39;s primary key, and no callbacks are executed.</p>

<p>Note that this will also delete records marked as <a href="Core.html#method-i-readonly-3F">#readonly?</a>.</p>

<p>To enforce the object&#39;s <code>before_destroy</code> and <code>after_destroy</code> callbacks or any <code>:dependent</code> association options, use <code>#destroy</code>.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-delete_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 323</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">delete</span>
  <span class="ruby-identifier">_delete_row</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">persisted?</span>
  <span class="ruby-ivar">@destroyed</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-identifier">freeze</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-destroy">
            
              destroy()
            
          </h3>

          
            <div class="description">
              <p>Deletes the record in the database and freezes this instance to reflect that no changes should be made (since they can&#39;t be persisted).</p>

<p>There&#39;s a series of callbacks associated with <a href="Persistence.html#method-i-destroy"><code>destroy</code></a>. If the <code>before_destroy</code> callback throws <code>:abort</code> the action is cancelled and <a href="Persistence.html#method-i-destroy"><code>destroy</code></a> returns <code>false</code>. See <a href="Callbacks.html"><code>ActiveRecord::Callbacks</code></a> for further details.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-destroy_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 336</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">destroy</span>
  <span class="ruby-identifier">_raise_readonly_record_error</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">readonly?</span>
  <span class="ruby-identifier">destroy_associations</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">add_transaction_record</span>(<span class="ruby-keyword">self</span>)
  <span class="ruby-ivar">@_trigger_destroy_callback</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">persisted?</span>
    <span class="ruby-identifier">destroy_row</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@destroyed</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-identifier">freeze</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-destroy-21">
            
              destroy!()
            
          </h3>

          
            <div class="description">
              <p>Deletes the record in the database and freezes this instance to reflect that no changes should be made (since they can&#39;t be persisted).</p>

<p>There&#39;s a series of callbacks associated with <a href="Persistence.html#method-i-destroy-21"><code>destroy!</code></a>. If the <code>before_destroy</code> callback throws <code>:abort</code> the action is cancelled and <a href="Persistence.html#method-i-destroy-21"><code>destroy!</code></a> raises <a href="RecordNotDestroyed.html"><code>ActiveRecord::RecordNotDestroyed</code></a>. See <a href="Callbacks.html"><code>ActiveRecord::Callbacks</code></a> for further details.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-destroy-21_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 356</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">destroy!</span>
  <span class="ruby-identifier">destroy</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">_raise_record_not_destroyed</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-destroyed-3F">
            
              destroyed?()
            
          </h3>

          
            <div class="description">
              <p>Returns true if this object has been destroyed, otherwise returns false.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-destroyed-3F_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 237</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">destroyed?</span>
  <span class="ruby-identifier">sync_with_transaction_state</span>
  <span class="ruby-ivar">@destroyed</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-increment">
            
              increment(attribute, by = 1)
            
          </h3>

          
            <div class="description">
              <p>Initializes <code>attribute</code> to zero if <code>nil</code> and adds the value passed as <code>by</code> (default is 1). The increment is performed directly on the underlying attribute, no setter is invoked. Only makes sense for number-based attributes. Returns <code>self</code>.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-increment_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 492</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">increment</span>(<span class="ruby-identifier">attribute</span>, <span class="ruby-identifier">by</span> = <span class="ruby-value">1</span>)
  <span class="ruby-keyword">self</span>[<span class="ruby-identifier">attribute</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">self</span>[<span class="ruby-identifier">attribute</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">by</span>
  <span class="ruby-keyword">self</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-increment-21">
            
              increment!(attribute, by = 1, touch: nil)
            
          </h3>

          
            <div class="description">
              <p>Wrapper around <a href="Persistence.html#method-i-increment"><code>increment</code></a> that writes the update to the database. Only <code>attribute</code> is updated; the record itself is not saved. This means that any other modified attributes will still be dirty. <a href="Validations.html"><code>Validations</code></a> and callbacks are skipped. Supports the <code>touch</code> option from <code>update_counters</code>, see that for more. Returns <code>self</code>.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-increment-21_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 504</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">increment!</span>(<span class="ruby-identifier">attribute</span>, <span class="ruby-identifier">by</span> = <span class="ruby-value">1</span>, <span class="ruby-value">touch:</span> <span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">increment</span>(<span class="ruby-identifier">attribute</span>, <span class="ruby-identifier">by</span>)
  <span class="ruby-identifier">change</span> = <span class="ruby-identifier">public_send</span>(<span class="ruby-identifier">attribute</span>) <span class="ruby-operator">-</span> (<span class="ruby-identifier">attribute_in_database</span>(<span class="ruby-identifier">attribute</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-operator">||</span> <span class="ruby-value">0</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">update_counters</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">attribute</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">change</span>, <span class="ruby-value">touch:</span> <span class="ruby-identifier">touch</span>)
  <span class="ruby-identifier">clear_attribute_change</span>(<span class="ruby-identifier">attribute</span>) <span class="ruby-comment"># eww</span>
  <span class="ruby-keyword">self</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-new_record-3F">
            
              new_record?()
            
          </h3>

          
            <div class="description">
              <p>Returns true if this object hasn&#39;t been saved yet – that is, a record for the object doesn&#39;t exist in the database yet; otherwise, returns false.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-new_record-3F_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 231</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">new_record?</span>
  <span class="ruby-identifier">sync_with_transaction_state</span>
  <span class="ruby-ivar">@new_record</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-persisted-3F">
            
              persisted?()
            
          </h3>

          
            <div class="description">
              <p>Returns true if the record is persisted, i.e. it&#39;s not a new record and it was not destroyed, otherwise returns false.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-persisted-3F_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 244</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">persisted?</span>
  <span class="ruby-identifier">sync_with_transaction_state</span>
  <span class="ruby-operator">!</span>(<span class="ruby-ivar">@new_record</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@destroyed</span>)
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-reload">
            
              reload(options = nil)
            
          </h3>

          
            <div class="description">
              <p>Reloads the record from the database.</p>

<p>This method finds the record by its primary key (which could be assigned manually) and modifies the receiver in-place:</p>

<pre><code>account = Account.new
# =&gt; #&lt;Account id: nil, email: nil&gt;
account.id = 1
account.reload
# Account Load (1.2ms)  SELECT &quot;accounts&quot;.* FROM &quot;accounts&quot; WHERE &quot;accounts&quot;.&quot;id&quot; = $1 LIMIT 1  [[&quot;id&quot;, 1]]
# =&gt; #&lt;Account id: 1, email: &#39;account@example.com&#39;&gt;
</code></pre>

<p><a href="Attributes.html"><code>Attributes</code></a> are reloaded from the database, and caches busted, in particular the associations cache and the <a href="QueryCache.html"><code>QueryCache</code></a>.</p>

<p>If the record no longer exists in the database <a href="RecordNotFound.html"><code>ActiveRecord::RecordNotFound</code></a> is raised. Otherwise, in addition to the in-place modification the method returns <code>self</code> for convenience.</p>

<p>The optional <code>:lock</code> flag option allows you to lock the reloaded record:</p>

<pre><code>reload(lock: true) # reload with pessimistic locking
</code></pre>

<p>Reloading is commonly used in test suites to test something is actually written to the database, or when some action modifies the corresponding row in the database but not the object in memory:</p>

<pre><code>assert account.deposit!(25)
assert_equal 25, account.credit        # check it is updated in memory
assert_equal 25, account.reload.credit # check it is also persisted
</code></pre>

<p>Another common use case is optimistic locking handling:</p>

<pre><code>def with_optimistic_retry
  begin
    yield
  rescue ActiveRecord::StaleObjectError
    begin
      # Reload lock_version in particular.
      reload
    rescue ActiveRecord::RecordNotFound
      # If the record is gone there is nothing to do.
    else
      retry
    end
  end
end
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-reload_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 602</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reload</span>(<span class="ruby-identifier">options</span> = <span class="ruby-keyword">nil</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">clear_query_cache</span>

  <span class="ruby-identifier">fresh_object</span> =
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:lock</span>]
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">unscoped</span> { <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">lock</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:lock</span>]).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>) }
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">unscoped</span> { <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>) }
    <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@attributes</span> = <span class="ruby-identifier">fresh_object</span>.<span class="ruby-identifier">instance_variable_get</span>(<span class="ruby-string">&quot;@attributes&quot;</span>)
  <span class="ruby-ivar">@new_record</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">self</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-save">
            
              save(*args)

            
          </h3>

          
            <div class="description">
              <p>Saves the model.</p>

<p>If the model is new, a record gets created in the database, otherwise the existing record gets updated.</p>

<p>By default, save always runs validations. If any of them fail the action is cancelled and <a href="Persistence.html#method-i-save"><code>save</code></a> returns <code>false</code>, and the record won&#39;t be saved. However, if you supply <code>validate: false</code>, validations are bypassed altogether. See <a href="Validations.html"><code>ActiveRecord::Validations</code></a> for more information.</p>

<p>By default, <a href="Persistence.html#method-i-save"><code>save</code></a> also sets the <code>updated_at</code>/<code>updated_on</code> attributes to the current time. However, if you supply <code>touch: false</code>, these timestamps will not be updated.</p>

<p>There&#39;s a series of callbacks associated with <a href="Persistence.html#method-i-save"><code>save</code></a>. If any of the <code>before_*</code> callbacks throws <code>:abort</code> the action is cancelled and <a href="Persistence.html#method-i-save"><code>save</code></a> returns <code>false</code>. See <a href="Callbacks.html"><code>ActiveRecord::Callbacks</code></a> for further details.</p>

<p><a href="Attributes.html"><code>Attributes</code></a> marked as readonly are silently ignored if the record is being updated.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-save_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 274</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">save</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
  <span class="ruby-identifier">create_or_update</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordInvalid</span>
  <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-save-21">
            
              save!(*args)

            
          </h3>

          
            <div class="description">
              <p>Saves the model.</p>

<p>If the model is new, a record gets created in the database, otherwise the existing record gets updated.</p>

<p>By default, <a href="Persistence.html#method-i-save-21"><code>save!</code></a> always runs validations. If any of them fail <a href="RecordInvalid.html"><code>ActiveRecord::RecordInvalid</code></a> gets raised, and the record won&#39;t be saved. However, if you supply <code>validate: false</code>, validations are bypassed altogether. See <a href="Validations.html"><code>ActiveRecord::Validations</code></a> for more information.</p>

<p>By default, <a href="Persistence.html#method-i-save-21"><code>save!</code></a> also sets the <code>updated_at</code>/<code>updated_on</code> attributes to the current time. However, if you supply <code>touch: false</code>, these timestamps will not be updated.</p>

<p>There&#39;s a series of callbacks associated with <a href="Persistence.html#method-i-save-21"><code>save!</code></a>. If any of the <code>before_*</code> callbacks throws <code>:abort</code> the action is cancelled and <a href="Persistence.html#method-i-save-21"><code>save!</code></a> raises <a href="RecordNotSaved.html"><code>ActiveRecord::RecordNotSaved</code></a>. See <a href="Callbacks.html"><code>ActiveRecord::Callbacks</code></a> for further details.</p>

<p><a href="Attributes.html"><code>Attributes</code></a> marked as readonly are silently ignored if the record is being updated.</p>

<p>Unless an error is raised, returns true.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-save-21_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 307</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">save!</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
  <span class="ruby-identifier">create_or_update</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">raise</span>(<span class="ruby-constant">RecordNotSaved</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;Failed to save the record&quot;</span>, <span class="ruby-keyword">self</span>))
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-toggle">
            
              toggle(attribute)
            
          </h3>

          
            <div class="description">
              <p>Assigns to <code>attribute</code> the boolean opposite of <code>attribute?</code>. So if the predicate returns <code>true</code> the attribute will become <code>false</code>. This method toggles directly the underlying value without calling any setter. Returns <code>self</code>.</p>

<p>Example:</p>

<pre><code>user = User.first
user.banned? # =&gt; false
user.toggle(:banned)
user.banned? # =&gt; true
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-toggle_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 541</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">toggle</span>(<span class="ruby-identifier">attribute</span>)
  <span class="ruby-keyword">self</span>[<span class="ruby-identifier">attribute</span>] = <span class="ruby-operator">!</span><span class="ruby-identifier">public_send</span>(<span class="ruby-node">&quot;#{attribute}?&quot;</span>)
  <span class="ruby-keyword">self</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-toggle-21">
            
              toggle!(attribute)
            
          </h3>

          
            <div class="description">
              <p>Wrapper around <a href="Persistence.html#method-i-toggle"><code>toggle</code></a> that saves the record. This method differs from its non-bang version in the sense that it passes through the attribute setter. Saving is not subjected to validation checks. Returns <code>true</code> if the record could be saved.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-toggle-21_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 550</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">toggle!</span>(<span class="ruby-identifier">attribute</span>)
  <span class="ruby-identifier">toggle</span>(<span class="ruby-identifier">attribute</span>).<span class="ruby-identifier">update_attribute</span>(<span class="ruby-identifier">attribute</span>, <span class="ruby-keyword">self</span>[<span class="ruby-identifier">attribute</span>])
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-touch">
            
              touch(*names, time: nil)
            
          </h3>

          
            <div class="description">
              <p>Saves the record with the updated_at/on attributes set to the current time or the time specified. Please note that no validation is performed and only the <code>after_touch</code>, <code>after_commit</code> and <code>after_rollback</code> callbacks are executed.</p>

<p>This method can be passed attribute names and an optional time argument. If attribute names are passed, they are updated along with updated_at/on attributes. If no time argument is passed, the current time is used as default.</p>

<pre><code>product.touch                         # updates updated_at/on with current time
product.touch(time: Time.new(2015, 2, 16, 0, 0, 0)) # updates updated_at/on with specified time
product.touch(:designed_at)           # updates the designed_at attribute and updated_at/on
product.touch(:started_at, :ended_at) # updates started_at, ended_at and updated_at/on attributes
</code></pre>

<p>If used along with <a href="Associations/ClassMethods.html#method-i-belongs_to">belongs_to</a> then <code>touch</code> will invoke <code>touch</code> method on associated object.</p>

<pre><code>class Brake &lt; ActiveRecord::Base
  belongs_to :car, touch: true
end

class Car &lt; ActiveRecord::Base
  belongs_to :corporation, touch: true
end

# triggers @brake.car.touch and @brake.car.corporation.touch
@brake.touch
</code></pre>

<p>Note that <code>touch</code> must be used on a persisted object, or else an <a href="ActiveRecordError.html"><code>ActiveRecordError</code></a> will be thrown. For example:</p>

<pre><code>ball = Ball.new
ball.touch(:updated_at)   # =&gt; raises ActiveRecordError
</code></pre>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-touch_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 651</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">touch</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">names</span>, <span class="ruby-value">time:</span> <span class="ruby-keyword">nil</span>)
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">persisted?</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecordError</span>, <span class="ruby-identifier">&lt;&lt;-MSG</span>.<span class="ruby-identifier">squish</span>
<span class="ruby-value">          cannot touch on a new or destroyed record object. Consider using
          persisted?, new_record?, or destroyed? before touching
</span><span class="ruby-identifier">        MSG</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">attribute_names</span> = <span class="ruby-identifier">timestamp_attributes_for_update_in_model</span>
      <span class="ruby-identifier">attribute_names</span> <span class="ruby-operator">|=</span> <span class="ruby-identifier">names</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:to_s</span>)

      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">attribute_names</span>.<span class="ruby-identifier">empty?</span>
        <span class="ruby-identifier">affected_rows</span> = <span class="ruby-identifier">_touch_row</span>(<span class="ruby-identifier">attribute_names</span>, <span class="ruby-identifier">time</span>)
        <span class="ruby-ivar">@_trigger_update_callback</span> = <span class="ruby-identifier">affected_rows</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">true</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-update">
            
              update(attributes)
            
          </h3>

          
            <div class="description">
              <p>Updates the attributes of the model from the passed-in hash and saves the record, all wrapped in a transaction. If the object is invalid, the saving will fail and false will be returned.</p>
            </div>
          

          
            <div class="aka">
              Also aliased as: <a href="Persistence.html#method-i-update_attributes">update_attributes</a>
            </div>
          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-update_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 423</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update</span>(<span class="ruby-identifier">attributes</span>)
  <span class="ruby-comment"># The following transaction covers any possible database side-effects of the</span>
  <span class="ruby-comment"># attributes assignment. For example, setting the IDs of a child collection.</span>
  <span class="ruby-identifier">with_transaction_returning_status</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">assign_attributes</span>(<span class="ruby-identifier">attributes</span>)
    <span class="ruby-identifier">save</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-update-21">
            
              update!(attributes)
            
          </h3>

          
            <div class="description">
              <p>Updates its receiver just like <a href="Persistence.html#method-i-update"><code>update</code></a> but calls <a href="Persistence.html#method-i-save-21"><code>save!</code></a> instead of <code>save</code>, so an exception is raised if the record is invalid and saving will fail.</p>
            </div>
          

          
            <div class="aka">
              Also aliased as: <a href="Persistence.html#method-i-update_attributes-21">update_attributes!</a>
            </div>
          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-update-21_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 436</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update!</span>(<span class="ruby-identifier">attributes</span>)
  <span class="ruby-comment"># The following transaction covers any possible database side-effects of the</span>
  <span class="ruby-comment"># attributes assignment. For example, setting the IDs of a child collection.</span>
  <span class="ruby-identifier">with_transaction_returning_status</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">assign_attributes</span>(<span class="ruby-identifier">attributes</span>)
    <span class="ruby-identifier">save!</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-update_attribute">
            
              update_attribute(name, value)
            
          </h3>

          
            <div class="description">
              <p>Updates a single attribute and saves the record. This is especially useful for boolean flags on existing records. Also note that</p>
<ul><li>
<p>Validation is skipped.</p>
</li><li>
<p>Callbacks are invoked.</p>
</li><li>
<p>updated_at/updated_on column is updated if that column is available.</p>
</li><li>
<p>Updates all the attributes that are dirty in this object.</p>
</li></ul>

<p>This method raises an <a href="ActiveRecordError.html"><code>ActiveRecord::ActiveRecordError</code></a>  if the attribute is marked as readonly.</p>

<p>Also see <a href="Persistence.html#method-i-update_column"><code>update_column</code></a>.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-update_attribute_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 412</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_attribute</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">value</span>)
  <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span>
  <span class="ruby-identifier">verify_readonly_attribute</span>(<span class="ruby-identifier">name</span>)
  <span class="ruby-identifier">public_send</span>(<span class="ruby-node">&quot;#{name}=&quot;</span>, <span class="ruby-identifier">value</span>)

  <span class="ruby-identifier">save</span>(<span class="ruby-value">validate:</span> <span class="ruby-keyword">false</span>)
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-update_attributes">
            
              update_attributes(attributes)
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          
            <div class="aka">
              Alias for: <a href="Persistence.html#method-i-update">update</a>
            </div>
          

          
          </div>
        
        <div class="method">
          <h3 id="method-i-update_attributes-21">
            
              update_attributes!(attributes)
            
          </h3>

          
            <div class="description">
              
            </div>
          

          

          
            <div class="aka">
              Alias for: <a href="Persistence.html#method-i-update-21">update!</a>
            </div>
          

          
          </div>
        
        <div class="method">
          <h3 id="method-i-update_column">
            
              update_column(name, value)
            
          </h3>

          
            <div class="description">
              <p>Equivalent to <code>update_columns(name =&gt; value)</code>.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-update_column_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 448</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_column</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">value</span>)
  <span class="ruby-identifier">update_columns</span>(<span class="ruby-identifier">name</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">value</span>)
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <h3 id="method-i-update_columns">
            
              update_columns(attributes)
            
          </h3>

          
            <div class="description">
              <p>Updates the attributes directly in the database issuing an UPDATE SQL statement and sets them in the receiver:</p>

<pre><code>user.update_columns(last_request_at: Time.current)
</code></pre>

<p>This is the fastest way to update attributes because it goes straight to the database, but take into account that in consequence the regular update procedures are totally bypassed. In particular:</p>
<ul><li>
<p>Validations are skipped.</p>
</li><li>
<p>Callbacks are skipped.</p>
</li><li>
<p><code>updated_at</code>/<code>updated_on</code> are not updated.</p>
</li><li>
<p>However, attributes are serialized with the same rules as <a href="Relation.html#method-i-update_all"><code>ActiveRecord::Relation#update_all</code></a></p>
</li></ul>

<p>This method raises an <a href="ActiveRecordError.html"><code>ActiveRecord::ActiveRecordError</code></a> when called on new objects, or when at least one of the attributes is marked as readonly.</p>
            </div>
          

          

          

          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source:
                
              </p>
              <div id="method-i-update_columns_source">
                <pre><code class="ruby"><span class="ruby-comment"># File activerecord/lib/active_record/persistence.rb, line 468</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_columns</span>(<span class="ruby-identifier">attributes</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecordError</span>, <span class="ruby-string">&quot;cannot update a new record&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_record?</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecordError</span>, <span class="ruby-string">&quot;cannot update a destroyed record&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">destroyed?</span>

  <span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">each_key</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">verify_readonly_attribute</span>(<span class="ruby-identifier">key</span>.<span class="ruby-identifier">to_s</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">id_in_database</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">id_in_database</span>
  <span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">write_attribute_without_type_cast</span>(<span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">affected_rows</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">_update_record</span>(
    <span class="ruby-identifier">attributes</span>,
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">primary_key</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">id_in_database</span>
  )

  <span class="ruby-identifier">affected_rows</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="ruby-keyword">end</span></code></pre>
              </div>
            </div>
            
          </div>
        
      
    
  
</div>

    </div>
</div>
